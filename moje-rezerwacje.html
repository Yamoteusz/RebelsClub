<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Moje rezerwacje — Rebels Club</title>
  <link rel="stylesheet" href="/css/style.css" />
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <style>
    .bookings{display:grid;gap:12px}
    .booking{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center}
    .badge{display:inline-block;padding:4px 8px;border:1px solid #1b2030;border-radius:999px;font-size:12px;color:#98a2b3}
    .actions{display:flex;gap:8px}
  </style>
</head>
<body>
  <nav class="nav"><div class="container nav-inner">
    <div class="brand"><div class="brand-mark">R</div><a href="/" class="club-name">Rebels Club</a></div>
    <div class="nav-links">
      <a href="/">Strona główna</a>
      <a href="/rezerwacje.html" class="btn btn-outline">Rezerwacje</a>
    </div>
  </div></nav>

  <section><div class="container">
    <div class="sec-head"><h2 class="sec-title">Moje rezerwacje</h2><span class="chip" id="auth">Logowanie…</span></div>
    <div id="list" class="bookings"></div>
  </div></section>


  <script>
  // === AUTH + STAN ===
  let user = null;
  const auth = document.getElementById('auth');
  const listEl = document.getElementById('list');

  function updateAuth(){
    if (user) {
      auth.textContent = user.email;
    } else {
      auth.innerHTML = 'Niezalogowano — <a href="#" onclick="window.netlifyIdentity.open();return false;">Zaloguj</a>';
      listEl.innerHTML = '<div class="card"><div class="card-body"><h3>Brak rezerwacji</h3><p class="meta">Zaloguj się, aby je zobaczyć.</p></div></div>';
    }
  }

  // === ŁADOWANIE LISTY Z FUNKCJI my-bookings ===
  let loading = false;
  async function load(){
  if (!user || loading) return;
  loading = true;
  try {
    // spróbuj pobrać token; jeśli się nie uda, użyj fallbacku z ?email=
    let token = null;
    try { token = await user.jwt(); } catch(e){ token = null; }

    const url = token
      ? '/.netlify/functions/my-bookings'
      : '/.netlify/functions/my-bookings?email=' + encodeURIComponent(user.email);

    const r = await fetch(url, {
      headers: token ? { Authorization: 'Bearer ' + token } : {}
    });

    const data = await r.json();
    render(Array.isArray(data.items) ? data.items : []);
  } catch (e) {
    listEl.innerHTML =
      '<div class="card"><div class="card-body"><h3>Błąd</h3><p class="meta">Nie udało się pobrać rezerwacji.</p></div></div>';
  } finally {
    loading = false;
  }
}


  // === Identity wydarzenia ===
  if (window.netlifyIdentity){
    window.netlifyIdentity.on('init',  u => { user = u; updateAuth(); if (u) load(); });
    window.netlifyIdentity.on('login', async u => { user = u; updateAuth(); await load(); });
    window.netlifyIdentity.on('logout', () => { user = null; updateAuth(); });
    // jeśli widget już był zainicjalizowany:
    setTimeout(() => {
      const u = window.netlifyIdentity.currentUser();
      user = u || null;
      updateAuth();
      if (u) load();
    }, 150);
  } else {
    updateAuth();
  }

  // === RENDER + ANULOWANIE (cancel-booking) ===
  function render(items){
    if (!items.length){
      listEl.innerHTML = '<div class="card"><div class="card-body"><h3>Brak rezerwacji</h3><p class="meta">Gdy zarezerwujesz termin, pojawi się tutaj.</p></div></div>';
      return;
    }

    // UWAGA: pola odpowiadają temu co zwraca funkcja my-bookings:
    //  slot_label, slot_iso, group, coach, room, status, email, created_at
    listEl.innerHTML = items.map(i => `
      <div class="card booking" data-iso="${i.slot_iso}">
        <div class="card-body">
          <div class="meta">
            ${i.group || 'Trening'}${i.room ? ` • Sala ${i.room}` : ''}${i.coach ? ` • ${i.coach}` : ''}
          </div>
          <h3>${i.slot_label}</h3>
          <div class="meta">E-mail: ${i.email || ''}</div>
          <span class="badge">${(i.status || 'Zatwierdzone')}</span>
        </div>
        <div class="actions card-body">
          ${ String(i.status).toLowerCase() === 'anulowane' ? '' : '<button class="btn btn-outline cancel">Anuluj</button>' }
        </div>
      </div>
    `).join('');

    // bind anulowania — wysyłamy TYLKO slot_iso do funkcji cancel-booking
    listEl.querySelectorAll('.cancel').forEach(btn => {
      btn.addEventListener('click', async ()=>{
        const card = btn.closest('.booking');
        const slotISO = card.dataset.iso;
        if (!confirm('Na pewno anulować tę rezerwację?')) return;

        try {
          const token = await user.jwt();
          const resp = await fetch('/.netlify/functions/cancel-booking', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: 'Bearer ' + token
            },
            body: JSON.stringify({ slot_iso: slotISO })
          });
          const j = await resp.json().catch(()=>({}));
          if (!resp.ok || !j.ok) throw new Error(j.error || 'Błąd anulowania');

          // odśwież listę po anulowaniu
          await load();
          alert('Rezerwacja anulowana.');
        } catch(e){
          alert('Błąd: ' + (e.message || 'Nie udało się anulować.'));
        }
      });
    });
  }
</script>


</body>
</html>
