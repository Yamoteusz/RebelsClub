<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rezerwacje — Rebels Club</title>
  <link rel="stylesheet" href="/css/style.css" />
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <style>
    .days-nav{display:flex;gap:8px;align-items:center;margin:10px 0 18px}
    .days-nav .btn{padding:8px 14px}
    .day-col{display:flex;flex-direction:column;gap:10px}
    .day-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
    .slot-btn.card{cursor:pointer}
    .muted{color:#98a2b3}
  </style>
</head>
<body>
  <nav class="nav">
    <div class="container nav-inner">
      <div class="brand"><div class="brand-mark">R</div><a href="/" class="club-name">Rebels Club</a></div>
      <div class="nav-links">
        <a href="/">Strona główna</a>
        <a href="/#grafik">Grafik</a>
        <a href="/#cennik">Cennik</a>
        <a href="/rezerwacje.html" class="btn">Rezerwacje</a>
      </div>
    </div>
  </nav>

  <section>
    <div class="container">
      <div class="sec-head">
        <h2 class="sec-title">Rezerwacje</h2>
        <span class="chip" id="auth-state">Logowanie…</span>
      </div>

      <div class="card"><div class="card-body">
        <div class="days-nav">
          <button id="prev" class="btn btn-outline" aria-label="Poprzednie dni">‹</button>
          <div class="muted">Zakres: <span id="range-label"></span></div>
          <button id="next" class="btn btn-outline" aria-label="Następne dni">›</button>
        </div>
        <div id="grid" class="cards" style="grid-template-columns:repeat(4,1fr)"></div>
        <p class="meta" id="legend" style="margin-top:10px;">Kliknij kafelek, aby zarezerwować. Domyślna pojemność slotu: 1 (edytowalna w CMS).</p>
      </div></div>

      <form name="rezerwacja" method="POST" action="/thanks-reservation.html" netlify netlify-honeypot="bot-field" id="book-form" style="display:none;">
        <input type="hidden" name="form-name" value="rezerwacja">
        <p style="display:none"><label>Nie wypełniaj: <input name="bot-field" /></label></p>
        <input type="hidden" name="user_email" id="f-user">
        <input type="hidden" name="slot_iso" id="f-iso">
        <input type="hidden" name="slot_label" id="f-label">
        <input type="hidden" name="group" id="f-group">
        <input type="hidden" name="coach" id="f-coach">
        <input type="hidden" name="room" id="f-room">
        <input type="hidden" name="capacity" id="f-cap">
      </form>
    </div>
  </section>

  <script>
  const DAYS = ["Niedziela","Poniedziałek","Wtorek","Środa","Czwartek","Piątek","Sobota"];
  const MONTHS = ["stycznia","lutego","marca","kwietnia","maja","czerwca","lipca","sierpnia","września","października","listopada","grudnia"];
  const asList = d => Array.isArray(d)?d:(d&&Array.isArray(d.ROOT)?d.ROOT:[]);
  const pad = n => String(n).padStart(2,'0');
  const addDays = (d, n)=>{const x=new Date(d); x.setDate(x.getDate()+n); return x;}
  function rangeLabel(a,b){return `${pad(a.getDate())} ${MONTHS[a.getMonth()]} — ${pad(b.getDate())} ${MONTHS[b.getMonth()]}`}

  // AUTH
  let currentUser = null;
  const authBadge = document.getElementById('auth-state');
  function updateAuthBadge(){
    if(!authBadge) return;
    if(currentUser){
      authBadge.textContent = `Zalogowano: ${currentUser.email}`;
    }else{
      authBadge.innerHTML = 'Niezalogowano — <a href="#" id="loginLink">Zaloguj / Zarejestruj</a>';
      setTimeout(()=>document.getElementById('loginLink')?.addEventListener('click',(e)=>{e.preventDefault(); window.netlifyIdentity?.open()}),0);
    }
  }
  if (window.netlifyIdentity) {
    window.netlifyIdentity.on('init', user => { currentUser=user; updateAuthBadge(); if(user) buildGrid(); });
    window.netlifyIdentity.on('login', user => { currentUser=user; updateAuthBadge(); buildGrid(); });
    window.netlifyIdentity.on('logout', () => { currentUser=null; updateAuthBadge(); buildGrid(); });

  }

  let startOffset=0;
  async function loadJSON(p, fb){ try{ const r=await fetch(p,{cache:'no-store'}); if(!r.ok) throw 0; return await r.json(); } catch(e){ return fb; } }

  function icsContent({title, startISO, durationMin=30, description='', location=''}){
    const dt = new Date(startISO);
    const dtEnd = new Date(dt.getTime()+durationMin*60000);
    const fmt = d => d.toISOString().replace(/[-:]/g,'').split('.')[0]+'Z';
    return [
      'BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//Rebels Club//EN',
      'BEGIN:VEVENT',
      `DTSTART:${fmt(dt)}`,
      `DTEND:${fmt(dtEnd)}`,
      `SUMMARY:${title}`,
      `DESCRIPTION:${description}`,
      `LOCATION:${location}`,
      'END:VEVENT','END:VCALENDAR'
    ].join('\r\n');
  }
  function downloadICS(args){
    const blob = new Blob([icsContent(args)], {type:'text/calendar'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'rezerwacja.ics'; a.click();
    URL.revokeObjectURL(url);
  }

  async function buildGrid(){
    const grid = document.getElementById('grid');
    const range = document.getElementById('range-label');
    if(!currentUser){
      grid.innerHTML = '<div class="card"><div class="card-body"><h3>Zaloguj się, aby rezerwować</h3><p class="meta">Kliknij „Zaloguj / Zarejestruj” powyżej.</p></div></div>';
      return;
    }
    const availRaw = await loadJSON('/data/availability.json', {ROOT:[]});
    const week = asList(availRaw);

    const daysCount = 14;
    const first = addDays(new Date(), startOffset);
    const last  = addDays(new Date(), startOffset + daysCount - 1);
    range.textContent = rangeLabel(first,last);

    const slotsByDay = {};
    for(let i=0;i<daysCount;i++){
      const d = addDays(first, i);
      slotsByDay[d.toDateString()] = { date:d, slots:[] };
    }

    for(const key in slotsByDay){
      const d = slotsByDay[key].date;
      const dayName = DAYS[d.getDay()];
      const defs = week.filter(w => w.day === dayName);
      for(const def of defs){
        const [sh, sm]=def.start.split(':').map(Number);
        const [eh, em]=def.end.split(':').map(Number);
        const step = def.step || 30;
        const start = new Date(d.getFullYear(), d.getMonth(), d.getDate(), sh, sm||0, 0);
        const end   = new Date(d.getFullYear(), d.getMonth(), d.getDate(), eh, em||0, 0);
        for(let t=new Date(start); t<end; t = new Date(t.getTime()+step*60000)){
          if (t < new Date()) continue;
          slotsByDay[key].slots.push({
            iso: t.toISOString(),
            time: `${pad(t.getHours())}:${pad(t.getMinutes())}`,
            label: `${dayName} • ${pad(t.getDate())}.${pad(t.getMonth()+1)} ${pad(t.getHours())}:${pad(t.getMinutes())}`,
            group: def.group||'Trening',
            coach: def.coach||'',
            room:  def.room||'',
            capacity: def.capacity||1
          });
        }
      }
    }

    const cols = Object.values(slotsByDay).map(day => {
      const d = day.date;
      const head = `<div class="day-head"><strong>${DAYS[d.getDay()]}</strong><span class="muted">${pad(d.getDate())} ${MONTHS[d.getMonth()]}</span></div>`;
      if(day.slots.length===0){
        return `<div class="day-col card"><div class="card-body">${head}<div class="muted">Brak terminów</div></div></div>`;
      }
      const items = day.slots.map(s=>`
        <button class="card slot-btn" data-iso="${s.iso}" data-label="${s.label}" data-group="${s.group}" data-coach="${s.coach}" data-room="${s.room}" data-cap="${s.capacity}">
          <div class="card-body">
            <div class="meta">${s.group}${s.room?` • Sala ${s.room}`:''}${s.coach?` • ${s.coach}`:''}</div>
            <h3>${s.time}</h3>
            <p class="meta">Pojemność: ${s.capacity}</p>
          </div>
        </button>`).join('');
      return `<div class="day-col">${head}${items}</div>`;
    }).join('');

    grid.innerHTML = cols;

    grid.querySelectorAll('button.slot-btn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        downloadICS({
          title: `Rezerwacja — ${btn.dataset.group}`,
          startISO: btn.dataset.iso,
          durationMin: 30,
          description: `Użytkownik: ${currentUser?.email || ''}\nSala: ${btn.dataset.room || ''}\nTrener: ${btn.dataset.coach || ''}`,
          location: 'Rebels Club, Twardogóra, Plac Piastów 24'
        });
        document.getElementById('f-user').value  = currentUser?.email || '';
        document.getElementById('f-iso').value   = btn.dataset.iso;
        document.getElementById('f-label').value = btn.dataset.label;
        document.getElementById('f-group').value = btn.dataset.group;
        document.getElementById('f-coach').value = btn.dataset.coach;
        document.getElementById('f-room').value  = btn.dataset.room;
        document.getElementById('f-cap').value   = btn.dataset.cap || '1';
        document.getElementById('book-form').submit();
      });
    });

    document.getElementById('prev').onclick = ()=>{ if(startOffset>=7){ startOffset-=7; buildGrid(); } };
    document.getElementById('next').onclick = ()=>{ startOffset+=7; buildGrid(); };
  }

  setTimeout(()=>{ if(window.netlifyIdentity){ updateAuthBadge(); if(window.netlifyIdentity.currentUser()) buildGrid(); } }, 200);
  </script>
</body>
</html>
